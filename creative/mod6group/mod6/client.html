<!DOCTYPE html>
<html>

<head>
    <title>Chat Room</title>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socketio = io.connect();
        var currentUserId = null;
        var currentRoomId = null;
        var users = [];

        function sendPrivateMessage() {
            var recipientUsername = document.getElementById("recipient_username").value;
            var message = document.getElementById("private_message_input").value;
            if (recipientUsername && message) {
                socketio.emit("private_message", { recipientUsername: recipientUsername, message: message, senderUserId: currentUserId });
                document.getElementById("private_message_input").value = '';
            }
        }

        function addUser(username, password, email) {
            users.push({ username: username, password: password, email: email });
        }

        function updateChat(messages) {
            var chatlog = document.getElementById("chatlog");
            chatlog.innerHTML = ''; // Clear current chatlog
            messages.forEach(function (msg) {
                var messageDiv = document.createElement("div");
                messageDiv.textContent = msg.username + ": " + msg.message_text;
                chatlog.appendChild(messageDiv);
            });
            chatlog.scrollTop = chatlog.scrollHeight; // Scroll to the bottom
        }

        function sendMessage() {
            var msg = document.getElementById("message_input").value;
            socketio.emit("message_to_server", { message: msg, userId: currentUserId, roomId: currentRoomId });
            document.getElementById("message_input").value = ''; // Clear the input after sending
        }

        function registerUser() {
            console.log("Register button clicked");
            var username = document.getElementById("register_username").value;
            var password = document.getElementById("register_password").value;
            var email = document.getElementById("register_email").value;

            // Check if the username is already taken on the client side
            var isUsernameTaken = users.some(function (user) {
                return user.username === username;
            });

            if (isUsernameTaken) {
                // Display an error message if the username is already taken
                document.getElementById("username_error").textContent = "Username is already taken.";
            } else {
                // Clear any previous error message
                document.getElementById("username_error").textContent = "";
                addUser(username, password, email);
                // Send the registration request to the server
                socketio.emit("register", { username: username, password: password, email: email });
            }
        }


        function loginUser() {
            var username = document.getElementById("login_username").value;
            var password = document.getElementById("login_password").value;
            socketio.emit("login", { username: username, password: password });
        }

        function createRoom() {
            var roomName = document.getElementById("room_name").value;
            var isPrivate = document.getElementById("is_private").checked;
            var password = document.getElementById("room_password").value;
            socketio.emit("create_room", { roomName: roomName, isPrivate: isPrivate, password: password, userId: currentUserId });
        }

        function checkRoomAndJoin(roomId) {
            // Emit an event to check the room's privacy status
            socketio.emit("check_room_privacy", { roomId: roomId });
        }

        socketio.on("room_privacy_status", function (data) {
            if (data.isPrivate) {
                // If the room is private, prompt for a password
                var password = prompt("This room is private. Please enter the password:");
                if (password != null) {
                    socketio.emit("join_room", { roomId: data.roomId, userId: currentUserId, password: password });
                }
            } else {
                // If the room is public, join without a password
                socketio.emit("join_room", { roomId: data.roomId, userId: currentUserId });
            }
        });

        socketio.on("you_have_been_kicked", function (data) {
            alert("You have been kicked from the room.");
            // Redirect the user to the Main Lobby
            joinRoom(data.mainLobbyId); // Call the joinRoom function with the Main Lobby's ID
        });

        socketio.on("you_have_been_banned", function (data) {
            alert("You have been banned from the room: " + data.roomName);
            joinRoom(data.mainLobbyId); // Call the joinRoom function with the Main Lobby's ID
        });


        // Update the joinRoom function to accept a roomId parameter
        function joinRoom(roomId) {
            if (!roomId) {
                roomId = document.getElementById("room_id").value;
            }
            checkRoomAndJoin(roomId); // Check the room's privacy status before joining
        }


        function banUser() {
            var usernameToBan = document.getElementById("user_to_manage").value;
            socketio.emit("ban_user", { roomId: currentRoomId, username: usernameToBan });
        }

        function kickUser() {
            var usernameToKick = document.getElementById("user_to_manage").value;
            socketio.emit("kick_user", { roomId: currentRoomId, username: usernameToKick });
        }



        socketio.on("room_join_success", function (data) {
            currentRoomId = data.roomId;
            document.getElementById("current_room_name").textContent = data.roomName; // Update the room name display
            alert("Joined room: " + data.roomName);
            if (data.isCreator) {
                document.getElementById("admin_panel").style.display = "block";
            } else {
                document.getElementById("admin_panel").style.display = "none";
            }
            if (data.messages && Array.isArray(data.messages)) {
                updateChat(data.messages);
            } else {
                // Handle the case where there are no messages or messages is not an array
                console.error('No messages to display', data);
            }
        });


        socketio.on("room_join_failed", function (message) {
            alert("Failed to join room: " + message);
        });



        socketio.on("message_to_client", function (data) {
            // Check if the message is for the current room
            if (data.roomId === currentRoomId) {
                var chatlog = document.getElementById("chatlog");
                var messageDiv = document.createElement("div");
                messageDiv.textContent = data.message;
                chatlog.appendChild(messageDiv);
                chatlog.scrollTop = chatlog.scrollHeight; // Scroll to the bottom
            }
        });

        socketio.on("registration_success", function (message) {
            alert(message);
        });

        socketio.on("registration_failed", function (message) {
            alert(message);
        });

        socketio.on("login_success", function (data) {
            alert("Login successful for user ID: " + data.userId);
            currentUserId = data.userId; // Set the current user ID
            // Show chat interface and hide login/register forms
            document.getElementById("login").style.display = "none";
            document.getElementById("register").style.display = "none";
            document.getElementById("chat_interface").style.display = "block";
            document.getElementById("room_creation").style.display = "block"; // Show room creation form
            document.getElementById("room_joining").style.display = "block"; // Show room joining form
            document.getElementById("private_messaging").style.display = "block";
        });

        socketio.on("login_failed", function (message) {
            alert(message);
        });

        socketio.on("room_creation_success", function (data) {
            alert("Room created with ID: " + data.roomId);
            // Update UI to show the room or switch to it
        });

        socketio.on("room_creation_failed", function (message) {
            alert(message);
        });

        socketio.on("user_banned", function (data) {
            alert(data.username + " has been banned.");
        });

        socketio.on("ban_failed", function (message) {
            alert("Ban failed: " + message);
        });

        socketio.on("user_kicked", function (data) {
            alert(data.username + " has been kicked.");
        });

        socketio.on("private_message_received", function (data) {
            alert("Private message from " + data.senderUsername + ":\n" + data.message);
        });

        socketio.on("private_message_failed", function (message) {
            alert("Private message failed: " + message);
        });


        socketio.on("kick_failed", function (message) {
            alert("Kick failed: " + message);
        });

    </script>
</head>

<body>
    <fieldset id="register">
        <legend>Registration</legend>
        <input type="text" id="register_username" placeholder="Username" />
        <span id="username_error" style="color: red;"></span>
        <input type="password" id="register_password" placeholder="Password" />
        <input type="text" id="register_email" placeholder="Email" />
        <button onclick="registerUser()">Register</button>
    </fieldset>

    <fieldset id="login">
        <legend>Login</legend>
        <input type="text" id="login_username" placeholder="Username" />
        <input type="password" id="login_password" placeholder="Password" />
        <button onclick="loginUser()">Login</button>
    </fieldset>

    <fieldset id="chat_interface" style="display:none;">
        <legend>Chat in <span id="current_room_name">Main Lobby</span></legend>
        <!-- Add a span to display the room name -->
        <input type="text" id="message_input" />
        <button onclick="sendMessage()">Send</button>
        <div id="chatlog"></div>
    </fieldset>

    <fieldset id="admin_panel" style="display:none;">
        <legend>Admin Panel</legend>
        <input type="text" id="user_to_manage" placeholder="Username to ban/kick" />
        <button onclick="banUser()">Ban User</button>
        <button onclick="kickUser()">Kick User</button>
    </fieldset>

    <fieldset id="private_messaging" style="display:none;">
        <legend>Private Messaging</legend>
        <input type="text" id="recipient_username" placeholder="Recipient Username" />
        <input type="text" id="private_message_input" placeholder="Message" />
        <button onclick="sendPrivateMessage()">Send Private Message</button>
    </fieldset>

    <fieldset id="room_creation" style="display:none;">
        <legend>Create a Room</legend>
        <input type="text" id="room_name" placeholder="Room Name" />
        <label><input type="checkbox" id="is_private" /> Private Room</label>
        <input type="password" id="room_password" placeholder="Password (for private rooms)" />
        <button onclick="createRoom()">Create Room</button>
    </fieldset>

    <fieldset id="room_joining" style="display:none;">
        <legend>Join a Room</legend>
        <input type="text" id="room_id" placeholder="Room ID" />
        <button onclick="joinRoom()">Join Room</button>
    </fieldset>
</body>

</html>